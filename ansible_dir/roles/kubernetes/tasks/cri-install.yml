---

- name: Remove old containerd package
  ansible.builtin.apt: 
    name: containerd
    state: absent

- name: Install containerd.io
  ansible.builtin.apt: 
    name: containerd.io
    state: present
    update_cache: yes 

# - name: Create local systemd directory
#   ansible.builtin.file: 
#     name: /usr/local/lib/systemd/system
#     state: directory

# - name: Get containerd service file
#   template:
#     src: containerd-systemd.service.j2
#     dest: /usr/local/lib/systemd/system/containerd.service
#     owner: root
#     group: root
#     mode: "0644"

# - name: Create CNI directory
#   ansible.builtin.file: 
#     name: /opt/cni/bin
#     state: directory

# - name: Unarchive CNI plugins
#   ansible.builtin.unarchive:
#     src:  "{{ cni_plugins_url }}"
#     dest: /opt/cni/bin
#     remote_src: yes

- name: Create containerd directory
  ansible.builtin.file: 
    name: /etc/containerd
    state: directory

# - name: Template containerd CNI plugin config file
#   template:
#     src: cni-10-containerd-net.conflist.j2
#     dest: /etc/cni/net.d/10-containerd-net.conflist
#     owner: root
#     group: root
#     mode: "0644"

# - name: Template containerd config file
#   template:
#     src: containerd-config.toml.j2
#     dest: /etc/containerd/config.toml
#     owner: root
#     group: root
#     mode: "0644"
#   notify:
#     - reload containerd

# - name: start and enable containerd
#   ansible.builtin.systemd:
#     name: containerd
#     state: restarted
#     enabled: yes
#     daemon_reload: true

- name: start and enable containerd
  ansible.builtin.systemd:
    name: containerd
    state: started
    enabled: yes
    daemon_reload: true

- name: Force all notified handlers to run now
  meta: flush_handlers